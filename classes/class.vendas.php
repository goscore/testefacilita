<?phprequire_once('dbconfig.php');class vendas{	private $conn;	public function __construct(){		$database = new Database();		$db = $database->dbConnection();		$this->conn = $db;    }	public function runQuery($sql){		$stmt = $this->conn->prepare($sql);		return $stmt;	}	public function getValorFinal($valor){        $carroid = $valor["carroid"];        if($carroid == ''){            $carroid = 0;            $valores['erro'] = "Selecione um carro";            return $valores;        }        $cor = $valor["coreid"];        if($cor == ''){            $cor = 0;            $valores['erro'] = "Selecione uma cor";            return $valores;        }        $vl_rodas = $valor["vl_rodas"];	    $valores = array();        $stmt = $this->conn->prepare("SELECT * FROM carros WHERE carroid =".$carroid);        $stmt->execute();        $s = $stmt->fetch();        $valores['marca'] = $s['marca'];        $valores['valorfinal'] = $s['preco'];        $stmt = $this->conn->prepare("SELECT variacao, nome FROM cores WHERE coreid =".$cor);        $stmt->execute();        $s = $stmt->fetch();        $valores['variacao'] = $s['variacao'];        $nomeCor = strtoupper(str_replace(' ', '', $s['nome']));        if($valores['variacao'] > 0){            /*             * Aplicar no sistema uma variação dinâmica de preços pela cor do veículo             */            $valores['valorfinal'] = $valores['valorfinal'] + ($valores['valorfinal'] * ($valores['variacao'] / 100));        }        $stmt = $this->conn->prepare("SELECT nome FROM marcas WHERE marcaid =".$valores['marca']);        $stmt->execute();        $s = $stmt->fetch();        $nomeMarca = strtoupper(str_replace(' ', '', $s['nome']));        $valores['nomeMarca'] = $nomeMarca;        $valores['desconto'] = 0;        if(($nomeMarca == 'HYUNDAI') and ($nomeCor != 'PRETO')){            /*             * No ato da venda, os carros da marca Hyundai, terão desconto de 7%.             * Se atente ao fato de que não haverá descontos para a cor Preta.             */            $valores['perc_desconto'] = 7;            $valores['desconto'] = ($valores['valorfinal'] * ($valores['perc_desconto'] / 100));            $valores['valorfinal'] = $valores['valorfinal'] - $valores['desconto'];        }        if(($vl_rodas > 0) and ($nomeCor == 'PRETO') and ($nomeMarca == 'FIAT')) {            /*             * A aplicação deverá aceitar no ato da compra a seleção de Rodas Liga Leve, porém apenas para carros na cor preta.             * Se atente ao fato de que este adicional só será cobrado na marca Fiat.             */            $valores['valorfinal'] = $valores['valorfinal'] + $vl_rodas;        }        $coresFIAT = array("PRETO", "BRANCO");        $coresVW = array("PRATA");        /*         * Se atente ao fato de que a Fiat terá apenas carros pretos e brancos, a Volkswagen apenas prata         * e a Hyundai possua todas as cores.         */        if($nomeMarca == 'FIAT'){            if(!in_array($nomeCor,$coresFIAT)){                $valores['erro'] = "FIAT não aceita esta cor!";            }        }        else if($nomeMarca == 'VOLKSWAGEN'){            if(!in_array($nomeCor,$coresVW)){                $valores['erro'] = "VOLKSWAGEN não aceita esta cor!";            }        }	    return $valores;    }	public function register($valor){		try{            $carroid = $valor["carroid"];            $cliente = $valor["cliente"];            $rodas = $valor["rodas"];            $vl_rodas = $valor["vl_rodas"];            $coreid= $valor['coreid'];            if($cliente==""){                return "preencha o cliente!";            }            else {                $dados = $this->getValorFinal($valor);                $variacao = $dados['variacao'];                $desconto = $dados['desconto'];                $valorfinal = $dados['valorfinal'];                if($dados['erro'] != ''){                    return $dados['erro'];                }                $stmt = $this->conn->prepare("INSERT INTO vendas(carroid,coreid,cliente,rodas,vl_rodas,variacao,desconto,valorfinal) VALUES(:carroid,:coreid,:cliente,:rodas,:vl_rodas,:variacao,:desconto,:valorfinal)");                $stmt->bindparam(":carroid", $carroid);                $stmt->bindparam(":coreid", $coreid);                $stmt->bindparam(":cliente", $cliente);                $stmt->bindparam(":rodas", $rodas);                $stmt->bindparam(":vl_rodas", $vl_rodas);                $stmt->bindparam(":variacao", $variacao);                $stmt->bindparam(":desconto", $desconto);                $stmt->bindparam(":valorfinal", $valorfinal);                $stmt->execute();                return "0";            }		}		catch(PDOException $e){			echo $e->getMessage();		}	}    public function deletar($uid){        try{            $stmt = $this->conn->prepare("UPDATE vendas SET excluido = 'S' WHERE vendaid = :uid");            $stmt->bindparam(":uid", $uid);            $stmt->execute();            return $stmt;        }        catch(PDOException $e) {            echo $e->getMessage();        }    }	public function redirect($url){		header("Location: $url");	}}?>